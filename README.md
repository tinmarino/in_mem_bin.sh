# In Memory Binary

| Shell | Debian | Archlinux | Alpine |
| ---   | ---    | ---       | --- |
| __bash__  | [![x86 Bash on Debian](https://img.shields.io/endpoint?url=https://gist.githubusercontent.com/tinmarino/7b40042f91625feffeaa1941f7aba953/raw/inmembin_x86_bash_on_debian_mode_unit.json)](https://github.com/tinmarino/inmembin/actions/workflows/x86.yml) [![arm Bash on Debian](https://img.shields.io/endpoint?url=https://gist.githubusercontent.com/tinmarino/7b40042f91625feffeaa1941f7aba953/raw/inmembin_arm_bash_on_debian_mode_unit.json)](https://github.com/tinmarino/inmembin/actions/workflows/arm.yml) <br/> [![x86 Bash on Debian](https://img.shields.io/endpoint?url=https://gist.githubusercontent.com/tinmarino/7b40042f91625feffeaa1941f7aba953/raw/inmembin_x86_bash_on_debian_mode_sync.json)](https://github.com/tinmarino/inmembin/actions/workflows/x86.yml) [![x86 Bash on Debian](https://img.shields.io/endpoint?url=https://gist.githubusercontent.com/tinmarino/7b40042f91625feffeaa1941f7aba953/raw/inmembin_x86_bash_on_debian_mode_async.json)](https://github.com/tinmarino/inmembin/actions/workflows/x86.yml) | [![x86 Bash on Arch](https://img.shields.io/endpoint?url=https://gist.githubusercontent.com/tinmarino/7b40042f91625feffeaa1941f7aba953/raw/inmembin_x86_bash_on_archlinux_mode_unit.json)](https://github.com/tinmarino/inmembin/actions/workflows/x86.yml) [![arm Bash on Arch](https://img.shields.io/endpoint?url=https://gist.githubusercontent.com/tinmarino/7b40042f91625feffeaa1941f7aba953/raw/inmembin_arm_bash_on_archlinux_mode_unit.json)](https://github.com/tinmarino/inmembin/actions/workflows/arm.yml) <br/> [![x86 Bash on Arch](https://img.shields.io/endpoint?url=https://gist.githubusercontent.com/tinmarino/7b40042f91625feffeaa1941f7aba953/raw/inmembin_x86_bash_on_archlinux_mode_sync.json)](https://github.com/tinmarino/inmembin/actions/workflows/x86.yml) [![x86 Bash on Arch](https://img.shields.io/endpoint?url=https://gist.githubusercontent.com/tinmarino/7b40042f91625feffeaa1941f7aba953/raw/inmembin_x86_bash_on_archlinux_mode_async.json)](https://github.com/tinmarino/inmembin/actions/workflows/x86.yml) | [![x86 Bash on Alpine](https://img.shields.io/endpoint?url=https://gist.githubusercontent.com/tinmarino/7b40042f91625feffeaa1941f7aba953/raw/inmembin_x86_bash_on_alpine_mode_unit.json)](https://github.com/tinmarino/inmembin/actions/workflows/x86.yml) [![arm Bash on Alpine](https://img.shields.io/endpoint?url=https://gist.githubusercontent.com/tinmarino/7b40042f91625feffeaa1941f7aba953/raw/inmembin_arm_bash_on_alpine_mode_unit.json)](https://github.com/tinmarino/inmembin/actions/workflows/arm.yml) <br/> [![x86 Bash on Alpine](https://img.shields.io/endpoint?url=https://gist.githubusercontent.com/tinmarino/7b40042f91625feffeaa1941f7aba953/raw/inmembin_x86_bash_on_alpine_mode_sync.json)](https://github.com/tinmarino/inmembin/actions/workflows/x86.yml) [![x86 Bash on Alpine](https://img.shields.io/endpoint?url=https://gist.githubusercontent.com/tinmarino/7b40042f91625feffeaa1941f7aba953/raw/inmembin_x86_bash_on_alpine_mode_async.json)](https://github.com/tinmarino/inmembin/actions/workflows/x86.yml) |
| __zsh__  | [![x86 Zsh on Debian](https://img.shields.io/endpoint?url=https://gist.githubusercontent.com/tinmarino/7b40042f91625feffeaa1941f7aba953/raw/inmembin_x86_zsh_on_debian_mode_unit.json)](https://github.com/tinmarino/inmembin/actions/workflows/x86.yml) [![arm Zsh on Debian](https://img.shields.io/endpoint?url=https://gist.githubusercontent.com/tinmarino/7b40042f91625feffeaa1941f7aba953/raw/inmembin_arm_zsh_on_debian_mode_unit.json)](https://github.com/tinmarino/inmembin/actions/workflows/arm.yml) <br/> [![x86 Zsh on Debian](https://img.shields.io/endpoint?url=https://gist.githubusercontent.com/tinmarino/7b40042f91625feffeaa1941f7aba953/raw/inmembin_x86_zsh_on_debian_mode_sync.json)](https://github.com/tinmarino/inmembin/actions/workflows/x86.yml) [![x86 Zsh on Debian](https://img.shields.io/endpoint?url=https://gist.githubusercontent.com/tinmarino/7b40042f91625feffeaa1941f7aba953/raw/inmembin_x86_zsh_on_debian_mode_async.json)](https://github.com/tinmarino/inmembin/actions/workflows/x86.yml) | [![x86 Zsh on Arch](https://img.shields.io/endpoint?url=https://gist.githubusercontent.com/tinmarino/7b40042f91625feffeaa1941f7aba953/raw/inmembin_x86_zsh_on_archlinux_mode_unit.json)](https://github.com/tinmarino/inmembin/actions/workflows/x86.yml) [![arm Zsh on Arch](https://img.shields.io/endpoint?url=https://gist.githubusercontent.com/tinmarino/7b40042f91625feffeaa1941f7aba953/raw/inmembin_arm_zsh_on_archlinux_mode_unit.json)](https://github.com/tinmarino/inmembin/actions/workflows/arm.yml) <br/> [![x86 Zsh on Arch](https://img.shields.io/endpoint?url=https://gist.githubusercontent.com/tinmarino/7b40042f91625feffeaa1941f7aba953/raw/inmembin_x86_zsh_on_archlinux_mode_sync.json)](https://github.com/tinmarino/inmembin/actions/workflows/x86.yml) [![x86 Zsh on Arch](https://img.shields.io/endpoint?url=https://gist.githubusercontent.com/tinmarino/7b40042f91625feffeaa1941f7aba953/raw/inmembin_x86_zsh_on_archlinux_mode_async.json)](https://github.com/tinmarino/inmembin/actions/workflows/x86.yml) | [![x86 Zsh on Alpine](https://img.shields.io/endpoint?url=https://gist.githubusercontent.com/tinmarino/7b40042f91625feffeaa1941f7aba953/raw/inmembin_x86_zsh_on_alpine_mode_unit.json)](https://github.com/tinmarino/inmembin/actions/workflows/x86.yml) [![arm Zsh on Alpine](https://img.shields.io/endpoint?url=https://gist.githubusercontent.com/tinmarino/7b40042f91625feffeaa1941f7aba953/raw/inmembin_arm_zsh_on_alpine_mode_unit.json)](https://github.com/tinmarino/inmembin/actions/workflows/arm.yml) <br/> [![x86 Zsh on Alpine](https://img.shields.io/endpoint?url=https://gist.githubusercontent.com/tinmarino/7b40042f91625feffeaa1941f7aba953/raw/inmembin_x86_zsh_on_alpine_mode_sync.json)](https://github.com/tinmarino/inmembin/actions/workflows/x86.yml) [![x86 Zsh on Alpine](https://img.shields.io/endpoint?url=https://gist.githubusercontent.com/tinmarino/7b40042f91625feffeaa1941f7aba953/raw/inmembin_x86_zsh_on_alpine_mode_async.json)](https://github.com/tinmarino/inmembin/actions/workflows/x86.yml) |
| __ash__  | [![x86 Ash on Debian](https://img.shields.io/endpoint?url=https://gist.githubusercontent.com/tinmarino/7b40042f91625feffeaa1941f7aba953/raw/inmembin_x86_ash_on_debian_mode_unit.json)](https://github.com/tinmarino/inmembin/actions/workflows/x86.yml) [![arm Ash on Debian](https://img.shields.io/endpoint?url=https://gist.githubusercontent.com/tinmarino/7b40042f91625feffeaa1941f7aba953/raw/inmembin_arm_ash_on_debian_mode_unit.json)](https://github.com/tinmarino/inmembin/actions/workflows/arm.yml) <br/> [![x86 Ash on Debian](https://img.shields.io/endpoint?url=https://gist.githubusercontent.com/tinmarino/7b40042f91625feffeaa1941f7aba953/raw/inmembin_x86_ash_on_debian_mode_sync.json)](https://github.com/tinmarino/inmembin/actions/workflows/x86.yml) [![x86 Ash on Debian](https://img.shields.io/endpoint?url=https://gist.githubusercontent.com/tinmarino/7b40042f91625feffeaa1941f7aba953/raw/inmembin_x86_ash_on_debian_mode_async.json)](https://github.com/tinmarino/inmembin/actions/workflows/x86.yml) | [![x86 Ash on Arch](https://img.shields.io/endpoint?url=https://gist.githubusercontent.com/tinmarino/7b40042f91625feffeaa1941f7aba953/raw/inmembin_x86_ash_on_archlinux_mode_unit.json)](https://github.com/tinmarino/inmembin/actions/workflows/x86.yml) [![arm Ash on Arch](https://img.shields.io/endpoint?url=https://gist.githubusercontent.com/tinmarino/7b40042f91625feffeaa1941f7aba953/raw/inmembin_arm_ash_on_archlinux_mode_unit.json)](https://github.com/tinmarino/inmembin/actions/workflows/arm.yml) <br/> [![x86 Ash on Arch](https://img.shields.io/endpoint?url=https://gist.githubusercontent.com/tinmarino/7b40042f91625feffeaa1941f7aba953/raw/inmembin_x86_ash_on_archlinux_mode_sync.json)](https://github.com/tinmarino/inmembin/actions/workflows/x86.yml) [![x86 Ash on Arch](https://img.shields.io/endpoint?url=https://gist.githubusercontent.com/tinmarino/7b40042f91625feffeaa1941f7aba953/raw/inmembin_x86_ash_on_archlinux_mode_async.json)](https://github.com/tinmarino/inmembin/actions/workflows/x86.yml) | [![x86 Ash on Alpine](https://img.shields.io/endpoint?url=https://gist.githubusercontent.com/tinmarino/7b40042f91625feffeaa1941f7aba953/raw/inmembin_x86_ash_on_alpine_mode_unit.json)](https://github.com/tinmarino/inmembin/actions/workflows/x86.yml) [![arm Ash on Alpine](https://img.shields.io/endpoint?url=https://gist.githubusercontent.com/tinmarino/7b40042f91625feffeaa1941f7aba953/raw/inmembin_arm_ash_on_alpine_mode_unit.json)](https://github.com/tinmarino/inmembin/actions/workflows/arm.yml) <br/> [![x86 Ash on Alpine](https://img.shields.io/endpoint?url=https://gist.githubusercontent.com/tinmarino/7b40042f91625feffeaa1941f7aba953/raw/inmembin_x86_ash_on_alpine_mode_sync.json)](https://github.com/tinmarino/inmembin/actions/workflows/x86.yml) [![x86 Ash on Alpine](https://img.shields.io/endpoint?url=https://gist.githubusercontent.com/tinmarino/7b40042f91625feffeaa1941f7aba953/raw/inmembin_x86_ash_on_alpine_mode_async.json)](https://github.com/tinmarino/inmembin/actions/workflows/x86.yml) |
| __ksh__  | [![x86 Ksh on Debian](https://img.shields.io/endpoint?url=https://gist.githubusercontent.com/tinmarino/7b40042f91625feffeaa1941f7aba953/raw/inmembin_x86_ksh_on_debian_mode_unit.json)](https://github.com/tinmarino/inmembin/actions/workflows/x86.yml) [![arm Ksh on Debian](https://img.shields.io/endpoint?url=https://gist.githubusercontent.com/tinmarino/7b40042f91625feffeaa1941f7aba953/raw/inmembin_arm_ksh_on_debian_mode_unit.json)](https://github.com/tinmarino/inmembin/actions/workflows/arm.yml) <br/> [![x86 Ksh on Debian](https://img.shields.io/endpoint?url=https://gist.githubusercontent.com/tinmarino/7b40042f91625feffeaa1941f7aba953/raw/inmembin_x86_ksh_on_debian_mode_sync.json)](https://github.com/tinmarino/inmembin/actions/workflows/x86.yml) [![x86 Ksh on Debian](https://img.shields.io/endpoint?url=https://gist.githubusercontent.com/tinmarino/7b40042f91625feffeaa1941f7aba953/raw/inmembin_x86_ksh_on_debian_mode_async.json)](https://github.com/tinmarino/inmembin/actions/workflows/x86.yml) | [![x86 Ksh on Arch](https://img.shields.io/endpoint?url=https://gist.githubusercontent.com/tinmarino/7b40042f91625feffeaa1941f7aba953/raw/inmembin_x86_ksh_on_archlinux_mode_unit.json)](https://github.com/tinmarino/inmembin/actions/workflows/x86.yml) [![arm Ksh on Arch](https://img.shields.io/endpoint?url=https://gist.githubusercontent.com/tinmarino/7b40042f91625feffeaa1941f7aba953/raw/inmembin_arm_ksh_on_archlinux_mode_unit.json)](https://github.com/tinmarino/inmembin/actions/workflows/arm.yml) <br/> [![x86 Ksh on Arch](https://img.shields.io/endpoint?url=https://gist.githubusercontent.com/tinmarino/7b40042f91625feffeaa1941f7aba953/raw/inmembin_x86_ksh_on_archlinux_mode_sync.json)](https://github.com/tinmarino/inmembin/actions/workflows/x86.yml) [![x86 Ksh on Arch](https://img.shields.io/endpoint?url=https://gist.githubusercontent.com/tinmarino/7b40042f91625feffeaa1941f7aba953/raw/inmembin_x86_ksh_on_archlinux_mode_async.json)](https://github.com/tinmarino/inmembin/actions/workflows/x86.yml) | [![x86 Ksh on Alpine](https://img.shields.io/endpoint?url=https://gist.githubusercontent.com/tinmarino/7b40042f91625feffeaa1941f7aba953/raw/inmembin_x86_ksh_on_alpine_mode_unit.json)](https://github.com/tinmarino/inmembin/actions/workflows/x86.yml) [![arm Ksh on Alpine](https://img.shields.io/endpoint?url=https://gist.githubusercontent.com/tinmarino/7b40042f91625feffeaa1941f7aba953/raw/inmembin_arm_ksh_on_alpine_mode_unit.json)](https://github.com/tinmarino/inmembin/actions/workflows/arm.yml) <br/> [![x86 Ksh on Alpine](https://img.shields.io/endpoint?url=https://gist.githubusercontent.com/tinmarino/7b40042f91625feffeaa1941f7aba953/raw/inmembin_x86_ksh_on_alpine_mode_sync.json)](https://github.com/tinmarino/inmembin/actions/workflows/x86.yml) [![x86 Ksh on Alpine](https://img.shields.io/endpoint?url=https://gist.githubusercontent.com/tinmarino/7b40042f91625feffeaa1941f7aba953/raw/inmembin_x86_ksh_on_alpine_mode_async.json)](https://github.com/tinmarino/inmembin/actions/workflows/x86.yml) |
| __sh__  | [![x86 Sh on Debian](https://img.shields.io/endpoint?url=https://gist.githubusercontent.com/tinmarino/7b40042f91625feffeaa1941f7aba953/raw/inmembin_x86_sh_on_debian_mode_unit.json)](https://github.com/tinmarino/inmembin/actions/workflows/x86.yml) [![arm Sh on Debian](https://img.shields.io/endpoint?url=https://gist.githubusercontent.com/tinmarino/7b40042f91625feffeaa1941f7aba953/raw/inmembin_arm_sh_on_debian_mode_unit.json)](https://github.com/tinmarino/inmembin/actions/workflows/arm.yml) <br/> [![x86 Sh on Arch](https://img.shields.io/endpoint?url=https://gist.githubusercontent.com/tinmarino/7b40042f91625feffeaa1941f7aba953/raw/inmembin_x86_sh_on_debian_mode_sync.json)](https://github.com/tinmarino/inmembin/actions/workflows/x86.yml) [![x86 Sh on Debian](https://img.shields.io/endpoint?url=https://gist.githubusercontent.com/tinmarino/7b40042f91625feffeaa1941f7aba953/raw/inmembin_x86_sh_on_debian_mode_async.json)](https://github.com/tinmarino/inmembin/actions/workflows/x86.yml) | [![x86 Sh on Arch](https://img.shields.io/endpoint?url=https://gist.githubusercontent.com/tinmarino/7b40042f91625feffeaa1941f7aba953/raw/inmembin_x86_sh_on_archlinux_mode_unit.json)](https://github.com/tinmarino/inmembin/actions/workflows/x86.yml) [![arm Sh on Arch](https://img.shields.io/endpoint?url=https://gist.githubusercontent.com/tinmarino/7b40042f91625feffeaa1941f7aba953/raw/inmembin_arm_sh_on_archlinux_mode_unit.json)](https://github.com/tinmarino/inmembin/actions/workflows/arm.yml) <br/> [![x86 Sh on Arch](https://img.shields.io/endpoint?url=https://gist.githubusercontent.com/tinmarino/7b40042f91625feffeaa1941f7aba953/raw/inmembin_x86_sh_on_debian_mode_sync.json)](https://github.com/tinmarino/inmembin/actions/workflows/x86.yml) [![x86 Sh on Debian](https://img.shields.io/endpoint?url=https://gist.githubusercontent.com/tinmarino/7b40042f91625feffeaa1941f7aba953/raw/inmembin_x86_sh_on_debian_mode_async.json)](https://github.com/tinmarino/inmembin/actions/workflows/x86.yml) | [![x86 Sh on Arch](https://img.shields.io/endpoint?url=https://gist.githubusercontent.com/tinmarino/7b40042f91625feffeaa1941f7aba953/raw/inmembin_x86_sh_on_archlinux_mode_unit.json)](https://github.com/tinmarino/inmembin/actions/workflows/x86.yml) [![arm Sh on Arch](https://img.shields.io/endpoint?url=https://gist.githubusercontent.com/tinmarino/7b40042f91625feffeaa1941f7aba953/raw/inmembin_arm_sh_on_archlinux_mode_unit.json)](https://github.com/tinmarino/inmembin/actions/workflows/arm.yml) <br/> [![x86 Sh on Arch](https://img.shields.io/endpoint?url=https://gist.githubusercontent.com/tinmarino/7b40042f91625feffeaa1941f7aba953/raw/inmembin_x86_sh_on_archlinux_mode_sync.json)](https://github.com/tinmarino/inmembin/actions/workflows/x86.yml) [![x86 Sh on Arch](https://img.shields.io/endpoint?url=https://gist.githubusercontent.com/tinmarino/7b40042f91625feffeaa1941f7aba953/raw/inmembin_x86_sh_on_archlinux_mode_async.json)](https://github.com/tinmarino/inmembin/actions/workflows/x86.yml) | [![x86 Sh on Alpine](https://img.shields.io/endpoint?url=https://gist.githubusercontent.com/tinmarino/7b40042f91625feffeaa1941f7aba953/raw/inmembin_x86_sh_on_alpine_mode_unit.json)](https://github.com/tinmarino/inmembin/actions/workflows/x86.yml) [![arm Sh on Alpine](https://img.shields.io/endpoint?url=https://gist.githubusercontent.com/tinmarino/7b40042f91625feffeaa1941f7aba953/raw/inmembin_arm_sh_on_alpine_mode_unit.json)](https://github.com/tinmarino/inmembin/actions/workflows/arm.yml) <br/> [![x86 Sh on Alpine](https://img.shields.io/endpoint?url=https://gist.githubusercontent.com/tinmarino/7b40042f91625feffeaa1941f7aba953/raw/inmembin_x86_sh_on_alpine_mode_sync.json)](https://github.com/tinmarino/inmembin/actions/workflows/x86.yml) [![Sh on Alpine](https://img.shields.io/endpoint?url=https://gist.githubusercontent.com/tinmarino/7b40042f91625feffeaa1941f7aba953/raw/inmembin_x86_sh_on_alpine_mode_async.json)](https://github.com/tinmarino/inmembin/actions/workflows/x86.yml) |

[![license](https://img.shields.io/badge/License-GPLv3-blue.svg)](LICENSE)
[![100% shell](https://img.shields.io/github/languages/top/tinmarino/inmembin.svg?style=flat-square)](https://github.com/shellspec/shellspec/search?l=Shell)
[![Typos](https://github.com/tinmarino/inmembin/workflows/Typos/badge.svg)](https://github.com/tinmarino/inmembin/actions/workflows/typos.yml)
[![Shellcheck](https://github.com/tinmarino/inmembin/workflows/Shellcheck/badge.svg)](https://github.com/tinmarino/inmembin/actions/workflows/shellcheck.yml)
[![Yamllint](https://github.com/tinmarino/inmembin/workflows/Yamllint/badge.svg)](https://github.com/tinmarino/inmembin/actions/workflows/yamllint.yml)
[![Codecov](https://codecov.io/github/tinmarino/inmembin/branch/ci/graph/badge.svg?token=TUQU7E6KT7)](https://app.codecov.io/gh/tinmarino/inmembin/blob/ci/inmembin.sh)

Execute binary code from shell without touching the filesystem. Hard copied from [arget13/ddsc.sh](https://github.com/arget13/DDexec/blob/49498ff6cc0bff4afe848565e6fe7d0558fab5f1/ddsc.sh)
# Content

| Chapter              | Content  |
| ---                  | --- |
| [Quickstart](#quick) | get in |
| [Requirement](#requirement)  | what you can expect |
| [Memory](#mem)       | memory access primitive<br/>[read](#read) [write](#write) [seek](#seek) |
| [Shell](#shell)      | lessons learned on posix shell<br/>[command](#command) [compat](#compat) [main](#main) [hex2dec](#hex2dec) [unhexify](#unhexify) [hexify](#hexify) [endian](#endian) [craft](#craft) |
| [Asm](#asm)          | assembly snippet used<br/>[0/debug](#debug) [1/dup2](#dup2) [2/memfd](#memfd) [3/ftruncate](#ftruncate) [4/pause](#pause) [5/mprotect](#mprotect) [6/restore](#restore) [7/mmap](#mmap)<br/> |
| [Todo](#todo)        | what is next |
| [Credit](#credit)    | @arget13 idea |
| [Link](#link)        | references |

# Quickstart <a name="quick"></a>

```sh
git clone --depth=1 https://github.com/tinmarino/inmembin && cd inmembin

/proc/self/exe ./inmembin.sh & pid=$!           # Create memfd
sleep 0.3 
cp "$(command which echo)" /proc/"$pid"/fd/4    # Fill it with a binary
/proc/"$pid"/fd/4 -e "\e[34mmy message\e[0m"    # Execute the in-mem binary
```

# Requirement <a name="requirement"></a>

* __Command__: dd <= used to seek, read and write memory. Posix shell limitation is that is is character wise (i.e null terminated strings) and not bytewise (i.e. supporting null bytes)
* __Shell__: bash zsh ash (dash) ksh (mksh) sh <= posix compliant tested shells
* __File__: /proc/self/syscalls /proc/self/maps /proc/self/mem <= used to hook instruction pointer, search memory and edit memory

# Memory access <a name="mem"></a>

### read <a name="read"></a>

```bash
xxd -s "$shellcode_addr_dec" -l 100  -c 100000 -p <&3
dd bs=1 count=100 skip=$shellcode_addr_dec <&3

setarch x86_64 -R bash -c "read -r syscall_info < /proc/self/syscall; echo \"$syscall_info\""0
0x0  0x55a7df932260 0x1000 0x2ca893f4 0x0 0xffffffff 0x7fff7835dbe8 0x7fb390914992
```

| N   | def             | x86 | arm | comment |
| --- | ---             | --- | --- | --- |
| 1   | sycall number   | rax | x8  | 0 => read |
| 2   | arg1            | rdi | x0  | address to read |
| 3   | arg2            | rsi | x1  | size to read |
| 4   | arg3            | rdx | x2  |   |
| 5   | arg4            | r10 | x3  |   |
| 6   | arg5            | r8  | x4  |   |
| 7   | arg6            | r9  | x5  |   |
| 8   | stack pointer   | rsp | sp  | maybe we can play here |
| 9   | program counter | rip | pc  | target: first instruction executed at return to userland |


### write <a name="write"></a>

TODO

### seek <a name="seek"></a>

Using the dd method

```sh
dd bs=1 skip="$1" > /dev/null 2>&1  # From coreutils
tail -c +$(( $1 + 1 )) >/dev/null 2>&1  # From coreutils + Bad for ksh
od -j $(( $1 + 1 )) -N 0 >/dev/null 2>&1  # From coreutils
cmp -i "$1" /dev/null > /dev/null 2>&1  # From diffutils
hexdump -s "$1" > /dev/null 2>&1  # From util-linux
xxd -s "$1" > /dev/null 2>&1  # From vim
```

Ksh is not supporting the `$(( $1 + 1 ))` arithmetic. This is unfortunate, I would have preferred to use tail like @arget13, just for personal affinity.

Silence error to avoid: error reading standard input: Bad file descriptor, which I do not care

# Posix shell <a name="shell"></a>

### Command cheatsheet <a name="command"></a>

* od
  * -t x1z: output in hex, 1 byte, with zero as tail
  * -v: do not cheat with * instead of newline
  * -N 10: read 10 next bytes
  * -j 4096: seek offset 4096 
* dd
  * count
  * skip
  * bs


### Shell compatibility <a name="compat"></a>

* __Bash__: default on Linux
  * BASH_VERSION is set
  * Limited to signed 64 bits integer arithmetic
* __Zsh__: default on Mac
  * ZSH_VERSION is set
* __Ash__: The smallest BSD, no more feature than Posix
  * Do not support `printf "\x41"`
* __Ksh__: Powerful for 1990 (pre 64 bits era)
  * KSH_VERSION is set
  * Limited to 32 bits integer arithmetic
  * Uses FD 3 to pass stdout and stdout on command redirection so echo $(read_mem) is not the same as read_mem is function read_mem uses FD 3 (as originally did)

### main <a name="main"></a>

The main routine is crafting and writing in memory

1. shellcode
2. jumper: small `jmp` instruction to jump to it.

### hex2dec <a name="hex2dec"></a>

Using the printf method

```sh
printf "%d" 0x10  # Posix compatible
$(( 0x10 ))  # More readable
```

Ksh (mksh) do not support 64 bit arithmetic and hardly support unsigned integer (I did not succeed). So the hex2dec: $((0x10)) used by @arget13 was replaced by printf "%d"

### unhexify <a name="unhexify"></a>

In shell, variable cannot hold null byte as strings are zero terminated. So byte streams must be send to pipes

```sh
printf "\\$(printf "%o" 0x41)"  # Posix compatible
printf "\x41"  # Bash but not posix compatible
```

### hexify <a name="hexify"></a>

TODO

### endian <a name="hex2dec"></a>

String indexing is not supported in sh and ash. As shellcode are supposed to be small, just invert pair of chars by preprending each next pair (like vim `:g/.*/m0`).

Initially I was appending, but anyway the `+=` operator is not supported in ash.

### craft shellcode and jumper <a name="craft"></a>

Embed hex strings of binaries, maybe with recently fetched pointers



# Asm <a name="asm"></a>


### 0/ debug <a name="debug"></a>

```nasm
".ELF"  ; 7f454c46
int    0x3  ; 0: cd 03 => just a sheetcheat

pop eax       ; 58
xor eax, eax  ; 31c0
```

```sh
nasm syscall_memfd_create.asm -o syscall_memfd_create.bin
objdump -b binary -m i386:x86-64 -D syscall_memfd_create.bin

sudo xxd -s $((0x7f5a53314992)) -c 10000 -l 10000 -p /proc/$$/mem | xxd -r -p > tail.bin

objdump -b binary -m i386:x86-64 -D -M intel tail.bin > tail.asm

setarch x86_64 -R bash inmembin.sh


# Get hex on ARM
file=arm; aarch64-linux-gnu-as -o $file.o $file.S  && aarch64-linux-gnu-objcopy -j.text -O binary $file.o $file  && xxd -c 10000 -p $file
```

#### Craft ARM move


```sh
printf %x $((  (0x0123 << 5) + (1 << 31) + (1 << 30) + (1 << 28) + (1 << 25) + (1 << 23) + (0 << 22) + (0 << 4) ))
# Reduces to
printf %x $(( 0xf2800000 + (0x0123 << 5) + (0 << 21) ))
```

Outputs: d2802460

where

```asm
mov     x0, #0x0123           // 602480d2
```


### 1/ [dup2](https://chromium.googlesource.com/chromiumos/docs/+/HEAD/constants/syscalls.md#arm_63) <a name="dup2"></a>

Arget13 is duplicating 0<-2 because his stdin was redirected from a pipe.

```nasm
xor    rax,rax  ; 0:   48 31 c0                
mov    rsi,rax  ; 3:   48 89 c6                
mov    al,0x2   ; 6:   b0 02                   
mov    rdi,rax  ; 8:   48 89 c7                
mov    al,0x21  ; b:   b0 21                   
syscall         ; d:   0f 05                   
```

```asm
mov     x8, #0x18  // 080380d2
mov     x0, #0x2   // 400080d2
mov     x1, #0x0   // 010080d2
svc     #0x0       // 010000d4
```

080380d2400080d2010080d2010000d4

### 2/ [memfd_create](https://chromium.googlesource.com/chromiumos/docs/+/HEAD/constants/syscalls.md#x86_64_319) <a name="memfd"></a>

```c
int memfd_create(char* filename, unsigned int flags)
// Return 4 <= FD // sig 0x164 for x86
```

If filename is NULL => Segmentation fault (I think this is subobtimal impl from Linux kernel as the name is useless)


Original: (20 bytes, including 8 to set filename string)


```nasm
push   0x44414544   ; 0:   68 44 45 41 44 => "DEAD"
mov    rdi,rsp      ; 5:   48 89 e7 => arg1: Point to "DEAD"
xor    rsi,rsi      ; 8:   48 31 f6 => arg2: Flag 0
mov    rax,rsi      ; b:   48 89 f0
mov    ah,0x1       ; e:   b4 01
mov    al,0x3f      ;10:   b0 3f
syscall             ;12:   0f 05
```

68444541444889e74831f64889f0b401b03f0f054889c7b04d0f05b0220f05

Naive: For comparison, here is my naive intent (17 bytes but crash)

```nasm
mov    eax,0x13f  ;0:   b8 3f 01 00 00          
mov    edi,0x0    ;5:   bf 00 00 00 00          
mov    esi,0x0    ;a:   be 00 00 00 00          
syscall           ;f:   0f 05                   
```

```asm
mov     x0, #0x4144           // 802888d2
movk    x0, #0x4445, lsl #16  // a088a8f2
str     x0, [sp, #-16]        // e00f1ff8
mov     x0, sp                // e0030091
eor     x1, x1, x1            // 210001ca
mov     x8, #0x117            // e82280d2
svc     #0x0                  // 010000d4
```

802888d2a088a8f2e00f1ff8e0030091210001cae82280d2010000d4

### 3/ [ftruncate](https://chromium.googlesource.com/chromiumos/docs/+/HEAD/constants/syscalls.md#x86_64_77) <a name="ftruncate"></a>
Optional, seems to be for early fail

```c
int truncate(const char *path, off_t length);  // sig 0x4d
// Return 0 => success
```

```nasm
mov    rdi,rax      ;14:   48 89 c7
mov    al,0x4d      ;17:   b0 4d
syscall             ;19:   0f 05
```

### 4/ [pause](https://chromium.googlesource.com/chromiumos/docs/+/HEAD/constants/syscalls.md#x86_64_34) <a name="pause"></a>
Wait for a signal

```c
int pause(void);
// Do not return or returns -1 in case a signal stopped it
// -- but, for me, return 0xfffffffffffffdfe = -514
// -- with debugger and ctrl-c
```

```nasm
mov    al,0x22      ;1b:   b0 22
syscall             ;1d:   0f 05
```

### 5/ [mprotect](https://chromium.googlesource.com/chromiumos/docs/+/HEAD/constants/syscalls.md#x86_64_10) <a name="mprotect"></a>
Page size is 4096

```c
int mprotect(void *addr, size_t len, int prot);
// sig x86: 0xa, sig arm: 0xe2
```

```nasm
; Can write to mem
mov rax, 0xa  ; mprotect
mov rdi, 0x7ffff7d14000  ; start addr
mov rdx, 0x7  ; R=1 W=2 X=4
mov rsi, 0x10000  ; jumper len
syscall
```

```asm
mov     x2, #0x3              // 620081d2: RW
mov     x1, #0x10000          // 2100a0d2: 16 pages
// Place holder to mov jumper immediate to x0
mov     x8, #0xe2             // 481c80d2: mprotect
svc     #0x0                  // 010000d4: syscall
```

481c80d2405999d24059b9f24059d9f24059f9f2e10080d2820180d2010000d4

### 6/ copy back content at jumper <a name="restore"></a>

```nasm
mov r15, 0x7ffff7d14992        ; jmp addr
mov [r15], dword 0xf0003d48    ; 4
mov [r15+4], dword 0x5677ffff  ; 8
mov [r15+8], dword 0x441f0fc3  ; 12
jmp r15
```

### 7/ mmap <a name="mmap"></a>

TODO Implementing for a nice extension, this should print the addr, as I do not see it in /proc/self/maps

# Temporary Dump

Jumper addr: page, hex, dec
7ffff7d14000
7ffff7d14992
140737351076242

# TODO <a name="todo"></a>

* [X] Remove the hardcoded setarch
* [X] Compatible with Alpine (the linker has other instruction <= DONE with read_mem using xxd for now)
* [ ] Find a way to cleanly jump after "infection"
* [ ] Create a memory maps to put arguments
* [ ] Get the return value of syscall in shell

* [ ] Get the ARM compliant version of core
* [ ] Doc: Improve doc with other files
* [ ] Implement some syscalls
* [ ] Refactor with core and syscall list

# Credit <a name="credit"></a>

Copied from [arget13/ddsc.sh](https://github.com/arget13/DDexec/blob/49498ff6cc0bff4afe848565e6fe7d0558fab5f1/ddsc.sh) => see credit there

# Link <a name="link"></a>

* [syscall and arguments (@google)](https://chromium.googlesource.com/chromiumos/docs/+/HEAD/constants/syscalls.md)
* [parent project (@arget: ddexec)](https://github.com/arget13/DDexec)
* [assembly code snippet (@Igor Zhirkov: low level programming)](https://github.com/Apress/low-level-programming)
* [local: error number list](file:/usr/include/asm-generic/errno-base.h)
* [local: memory protection list](file:/usr/include/asm-generic/mman-common.h)
* [list of posix complaint shell (@archliux)](https://wiki.archlinux.org/title/command-line_shell)
* [awesome shell list (@github)](https://github.com/alebcay/awesome-shell)
* [posix shell specification](https://pubs.opengroup.org/onlinepubs/9699919799.2018edition/utilities/V3_chap02.html#tag_18_12)
* [arm instruction set](https://developer.arm.com/documentation/ddi0596/2021-12/Base-Instructions)
